<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Offline Transaction Tracker</title>
<style>
body { font-family: Arial, sans-serif; padding: 10px; background: #f2f2f2; }
h2 { text-align: center; }
form { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
input { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
button { padding: 10px; width: 100%; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 5px; }
button.voice-btn { background: #2196F3; }
table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; }
th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
th { background: #4CAF50; color: white; }
tfoot td { font-weight: bold; }
tr.swipe-row { transition: transform 0.3s ease, background 0.3s ease; touch-action: pan-y; }
</style>
</head>
<body>

<h2>Offline Transaction Tracker</h2>

<form id="transactionForm">
  <input type="date" id="date" required>
  <input type="text" id="description" placeholder="Description" required>
  <input type="number" id="amount" placeholder="Amount" required>
  <button type="button" class="voice-btn" onclick="startVoiceInput()">ðŸŽ¤ Voice Input</button>
  <button type="submit">Add Transaction</button>
</form>

<button onclick="exportCSV()">Export to CSV</button>

<table id="transactionTable">
  <thead>
    <tr>
      <th>Date</th>
      <th>Description</th>
      <th>Amount</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="2">Total</td>
      <td id="totalAmount">0.00</td>
    </tr>
  </tfoot>
</table>

<script>
let db, editId = null;
document.getElementById("date").valueAsDate = new Date();

// IndexedDB setup
let request = indexedDB.open("TransactionDB", 1);
request.onerror = e => alert("DB error: " + e.target.errorCode);
request.onsuccess = e => { db = e.target.result; displayTransactions(); };
request.onupgradeneeded = e => {
  db = e.target.result;
  let store = db.createObjectStore("transactions", { keyPath: "id", autoIncrement: true });
  store.createIndex("date","date",{unique:false});
  store.createIndex("description","description",{unique:false});
  store.createIndex("amount","amount",{unique:false});
};

// Add/update transaction
document.getElementById("transactionForm").addEventListener("submit", e => {
  e.preventDefault();
  let date = document.getElementById("date").value;
  let description = document.getElementById("description").value;
  let amount = parseFloat(document.getElementById("amount").value);
  if(!description || isNaN(amount)) return alert("Enter valid data");
  let transaction = { date, description, amount };
  let store = db.transaction("transactions","readwrite").objectStore("transactions");
  if(editId !== null){
    transaction.id = editId;
    store.put(transaction).onsuccess = ()=>{ editId=null; displayTransactions(); resetForm(); };
  } else store.add(transaction).onsuccess = ()=>{ displayTransactions(); resetForm(); };
});

function resetForm(){
  document.getElementById("transactionForm").reset();
  document.getElementById("date").valueAsDate = new Date();
  document.querySelector("button[type='submit']").textContent="Add Transaction";
}

// Display transactions with swipe gestures
function displayTransactions(){
  let tbody = document.querySelector("#transactionTable tbody");
  tbody.innerHTML="";
  let total=0;
  let store = db.transaction("transactions").objectStore("transactions");
  store.openCursor().onsuccess = function(e){
    let cursor = e.target.result;
    if(cursor){
      let tr=document.createElement("tr");
      tr.classList.add("swipe-row");
      tr.dataset.id = cursor.value.id; // save id for gesture
      tr.innerHTML = `<td>${cursor.value.date}</td><td>${cursor.value.description}</td><td>${cursor.value.amount.toFixed(2)}</td>`;
      
      // Gesture control
      let startX=0;
      tr.addEventListener("touchstart", evt=>startX=evt.touches[0].clientX);
      tr.addEventListener("touchmove", evt=>{
        let moveX=evt.touches[0].clientX - startX;
        tr.style.transform=`translateX(${moveX}px)`;
        tr.style.background = moveX>0 ? "#FFF3CD" : moveX<0 ? "#F8D7DA" : "#fff";
      });
      tr.addEventListener("touchend", evt=>{
        let endX=evt.changedTouches[0].clientX;
        let diff=endX-startX;
        tr.style.transform="translateX(0px)";
        tr.style.background="#fff";
        if(diff>100) editTransaction(cursor.value);   // swipe right â†’ edit
        else if(diff<-100) deleteTransaction(cursor.value.id); // swipe left â†’ delete
      });

      tbody.appendChild(tr);
      total+=cursor.value.amount;
      cursor.continue();
    }
    document.getElementById("totalAmount").textContent=total.toFixed(2);
  };
}

// Edit transaction
function editTransaction(data){
  document.getElementById("date").value = data.date;
  document.getElementById("description").value = data.description;
  document.getElementById("amount").value = data.amount;
  editId = data.id;
  document.querySelector("button[type='submit']").textContent="Update Transaction";
}

// Delete transaction
function deleteTransaction(id){
  if(confirm("Delete this transaction?")){
    db.transaction("transactions","readwrite").objectStore("transactions").delete(id).onsuccess=displayTransactions;
  }
}

// Export CSV
function exportCSV(){
  let rows=[["Date","Description","Amount"]];
  let store=db.transaction("transactions").objectStore("transactions");
  store.openCursor().onsuccess=function(e){
    let cursor=e.target.result;
    if(cursor){
      rows.push([cursor.value.date,cursor.value.description,cursor.value.amount]);
      cursor.continue();
    } else {
      let csv="data:text/csv;charset=utf-8,"+rows.map(r=>r.join(",")).join("\n");
      let link=document.createElement("a");
      link.href=encodeURI(csv);
      link.download="transactions.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  };
}

// Voice input
function startVoiceInput(){
  if(!('webkitSpeechRecognition' in window)) return alert("Voice not supported!");
  let recognition=new webkitSpeechRecognition();
  recognition.lang="en-US";
  recognition.interimResults=false;
  recognition.maxAlternatives=1;
  recognition.start();
  recognition.onresult=function(event){
    let speech=event.results[0][0].transcript;
    let match=speech.match(/([\d.]+)\s*(?:rs|rupees|amount)?\s*(.*)/i);
    if(match){
      document.getElementById("amount").value=match[1];
      document.getElementById("description").value=match[2] || "";
    } else {
      document.getElementById("description").value=speech;
    }
  };
}
</script>
</body>
</html>
