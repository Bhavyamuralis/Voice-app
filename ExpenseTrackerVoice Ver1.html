<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expense Tracker</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #4361ee;
    --secondary: #3f37c9;
    --success: #4cc9f0;
    --danger: #f72585;
    --warning: #f8961e;
    --info: #4895ef;
    --light: #f8f9fa;
    --dark: #212529;
    --gray: #6c757d;
    --light-gray: #e9ecef;
    --card-bg: #ffffff;
    --body-bg: #f5f7fb;
    --text-primary: #2d3748;
    --text-secondary: #718096;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 8px 16px rgba(0, 0, 0, 0.12);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    background: var(--body-bg);
    color: var(--text-primary);
    line-height: 1.6;
    overflow-x: hidden;
    position: relative;
    min-height: 100vh;
    padding-bottom: 80px;
  }

  /* Header */
  header {
    background: var(--primary);
    color: white;
    padding: 16px;
    text-align: center;
    font-size: 22px;
    font-weight: 700;
    box-shadow: var(--shadow);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  /* Container */
  .container {
    padding: 16px;
    max-width: 600px;
    margin: 0 auto;
  }

  /* Cards */
  .card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .card:active {
    transform: translateY(2px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  /* Buttons */
  .btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 16px;
    margin: 10px 0;
    border: none;
    border-radius: 14px;
    font-size: 16px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: var(--shadow);
  }

  .btn:active {
    transform: scale(0.98);
  }

  .btn-category {
    background: var(--primary);
  }

  .btn-subcategory {
    background: var(--info);
  }

  .btn-back {
    background: var(--secondary);
  }

  .btn-export {
    background: var(--success);
  }

  /* Toolbar */
  .toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
  }

  .switch, .lang-btn, .export-btn {
    cursor: pointer;
    padding: 10px 16px;
    border-radius: 50px;
    border: none;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
  }

  .switch:active, .lang-btn:active, .export-btn:active {
    transform: scale(0.95);
  }

  .switch {
    background: var(--light);
    color: var(--primary);
  }

  .switch.active {
    background: var(--primary);
    color: white;
  }

  .lang-btn, .export-btn {
    background: var(--light);
    color: var(--primary);
  }

  /* Records View */
  .records-container {
    margin-top: 15px;
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  .date-group {
    border-bottom: 1px solid var(--light-gray);
  }

  .date-header {
    padding: 16px;
    background: var(--light);
    color: var(--text-secondary);
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  .date-header:hover {
    background-color: #e2e6ea;
  }

  .date-header i {
    transition: transform 0.3s ease;
  }

  .date-header.collapsed i {
    transform: rotate(-90deg);
  }

  .date-total {
    font-weight: 700;
    color: var(--primary);
  }

  .date-content {
    overflow: hidden;
    transition: max-height 0.4s ease;
  }

  .date-content.collapsed {
    max-height: 0;
  }

  .category-group {
    padding: 12px 16px;
    border-bottom: 1px solid var(--light-gray);
    background: rgba(0, 0, 0, 0.02);
  }

  .category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .category-name {
    font-weight: 600;
    color: var(--text-primary);
  }

  .category-total {
    font-weight: 600;
    color: var(--info);
  }

  /* Expense Table - FIXED EQUAL COLUMNS */
  .expense-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed; /* This will make columns equal width */
  }

  .expense-table th,
  .expense-table td {
    padding: 12px 8px;
    border-bottom: 1px solid var(--light-gray);
    vertical-align: top;
    line-height: 1.5;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .expense-table th {
    text-align: left;
    color: var(--text-secondary);
    font-weight: 600;
    background: var(--light);
  }

  .expense-table tr:last-child td {
    border-bottom: none;
  }

  /* Set equal width for all columns */
  .expense-table th:nth-child(1),
  .expense-table td:nth-child(1) {
    width: 30%;
  }

  .expense-table th:nth-child(2),
  .expense-table td:nth-child(2) {
    width: 45%;
  }

  .expense-table th:nth-child(3),
  .expense-table td:nth-child(3) {
    width: 25%;
    text-align: right;
  }

  .expense-subcategory {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
  }

  .expense-description {
    color: var(--text-secondary);
    font-size: 0.9em;
  }

  .expense-amount {
    font-weight: 700;
    color: var(--primary);
  }

  /* Swipe actions */
  .swipe-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 8px;
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    height: 0;
    overflow: hidden;
  }

  .expense-item.show-actions .swipe-actions {
    opacity: 1;
    transform: translateY(0);
    height: auto;
  }

  .swipe-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .swipe-btn.edit {
    background: var(--warning);
    color: white;
  }

  .swipe-btn.delete {
    background: var(--danger);
    color: white;
  }

  .swipe-btn:hover {
    opacity: 0.9;
  }

  .total-display {
    text-align: right;
    font-weight: bold;
    margin: 20px 5px;
    font-size: 18px;
    color: var(--text-primary);
    padding: 16px;
    background: var(--light);
    border-radius: 16px;
  }

  /* Floating action button */
  .fab {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    z-index: 90;
    transition: all 0.3s ease;
  }

  .fab:active {
    transform: scale(0.9);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes pulse {
    from { transform: scale(1); }
    to { transform: scale(1.05); }
  }

  @keyframes swipe {
    from { transform: translateX(0); }
    to { transform: translateX(-80px); }
  }

  .animate-fadeIn {
    animation: fadeIn 0.4s ease forwards;
  }

  /* Voice listening indicator */
  .voice-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 20px 0;
    padding: 16px;
    background: var(--light);
    border-radius: 16px;
    box-shadow: var(--shadow);
  }

  .pulse-dot {
    width: 12px;
    height: 12px;
    background: var(--danger);
    border-radius: 50%;
    margin-right: 12px;
    animation: pulse 1.5s infinite;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
  }

  .empty-state i {
    font-size: 48px;
    margin-bottom: 16px;
    color: var(--light-gray);
  }

  /* View transitions */
  .view {
    display: none;
  }

  .view.active {
    display: block;
    animation: fadeIn 0.4s ease;
  }

  /* Responsive adjustments */
  @media (max-width: 480px) {
    .container {
      padding: 12px;
    }
    
    .card {
      padding: 16px;
    }
    
    .date-header, .category-group {
      padding: 12px;
    }
    
    .toolbar {
      flex-direction: column;
      align-items: stretch;
    }
    
    .switch, .lang-btn, .export-btn {
      width: 100%;
      justify-content: center;
    }
    
    .expense-table {
      font-size: 14px;
    }
    
    .expense-table th, 
    .expense-table td {
      padding: 10px 6px;
    }

    /* Adjust column widths for mobile */
    .expense-table th:nth-child(1),
    .expense-table td:nth-child(1) {
      width: 30%;
    }

    .expense-table th:nth-child(2),
    .expense-table td:nth-child(2) {
      width: 40%;
    }

    .expense-table th:nth-child(3),
    .expense-table td:nth-child(3) {
      width: 30%;
    }
  }

  /* Ripple effect */
  .ripple {
    position: relative;
    overflow: hidden;
  }

  .ripple:after {
    content: "";
    display: block;
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    pointer-events: none;
    background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
    background-repeat: no-repeat;
    background-position: 50%;
    transform: scale(10, 10);
    opacity: 0;
    transition: transform .5s, opacity 1s;
  }

  .ripple:active:after {
    transform: scale(0, 0);
    opacity: .3;
    transition: 0s;
  }

  /* Swipeable item */
  .expense-item {
    position: relative;
    transition: transform 0.3s ease;
    overflow: hidden;
    border-bottom: 1px solid var(--light-gray);
    background: white;
  }

  .expense-item.swiped {
    transform: translateX(-80px);
  }

  .expense-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    position: relative;
    z-index: 1;
    background: white;
  }

  .expense-info {
    flex: 1;
  }

  .expense-actions {
    position: absolute;
    right: -80px;
    top: 0;
    width: 80px;
    height: 100%;
    display: flex;
    transition: right 0.3s ease;
  }

  .expense-item.swiped .expense-actions {
    right: 0;
  }

  .action-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    border: none;
    cursor: pointer;
  }

  .action-edit {
    background: var(--warning);
  }

  .action-delete {
    background: var(--danger);
  }

  /* Toast notification */
  .toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 12px 24px;
    border-radius: 50px;
    z-index: 1000;
    font-weight: 500;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }
</style>
</head>
<body>
<header>
  <div>Expense Tracker</div>
</header>

<div class="toolbar">
  <button class="lang-btn" id="langBtn">
    <i class="fas fa-language"></i>
    <span id="langText">Telugu</span>
  </button>
  <button class="export-btn" id="exportBtn">
    <i class="fas fa-file-export"></i>
    <span>Export CSV</span>
  </button>
  <button class="switch" id="stayToggle">
    <i class="fas fa-power-off"></i>
    <span id="stayText">Stay OFF</span>
  </button>
</div>

<div class="container">
  <div class="view active" id="categoryView">
    <div class="card">
      <h3><i class="fas fa-folder-open"></i> Select Category</h3>
      <div id="categoryButtons"></div>
    </div>
  </div>

  <div class="view" id="subcategoryView">
    <div class="card">
      <h3 id="subcategoryTitle"><i class="fas fa-list"></i> Select Subcategory</h3>
      <div id="subcategoryButtons"></div>
      <button class="btn btn-back" onclick="showView('categoryView')">
        <i class="fas fa-arrow-left"></i> Back
      </button>
    </div>
  </div>

  <div class="view" id="voiceView">
    <div class="card">
      <h3 id="voiceTitle"><i class="fas fa-microphone"></i> Speak Now</h3>
      <div class="voice-indicator">
        <div class="pulse-dot"></div>
        <div>Listening... Say something like "Milk 50"</div>
      </div>
      <button class="btn btn-back" onclick="showView('subcategoryView')">
        <i class="fas fa-arrow-left"></i> Back
      </button>
    </div>
  </div>

  <div class="view" id="recordsView">
    <div class="card">
      <h3><i class="fas fa-history"></i> Expense History</h3>
      <div id="recordsContainer" class="records-container"></div>
      <div class="total-display" id="totalDisplay">Total: ₹0</div>
      <button class="btn btn-export" onclick="exportToCSV()">
        <i class="fas fa-file-export"></i> Export to CSV
      </button>
    </div>
  </div>
</div>

<div class="fab" onclick="showView('categoryView')">
  <i class="fas fa-plus"></i>
</div>

<script>
// Data and State Management
let categories = {
  "Needs": [
    "House Rent", "Electricity Bill", "Cable Bill", "Phone Bill", 
    "Transportation", "Beverages/Dairy", "Gas", "Rice", "Groceries", 
    "Vegetable", "Non Vegitable", "Fruits", "Bakery/Snacks", "Cleaners/Personal Care"
  ],
  "Wants": [
    "Repairs & Maintenance", "Shopping", "Entertainment", "Vacation",
    "Charity/Donations/Gifts", "Clothing/Beauty", "EatOut", "Other"
  ],
  "Medical/Healthcare": [
    "Hospital", "Medicine", "Lab Reports"
  ],
  "Education": [
    "Exam Fee", "Books", "Stationery", "Admission Fee", "Tutoring Fee"
  ],
  "Banking/Finance": [
    "Debts", "Insurance", "ATM/SMS Charges", "Fund Transfer Charges",
    "Salary Deductions", "Tax", "Account Maintenance Charges", "Losses On Investment"
  ]
};

let currentCategory = "";
let currentSubcategory = "";
let currentLang = "te-IN"; // default Telugu
let stayOn = false;
let speechRecognition = null;
let recognitionTimeout = null;
let collapsedDates = {}; // Track which dates are collapsed
let activeSwipeItem = null; // Track which item is currently swiped

// DOM Elements
const stayToggle = document.getElementById("stayToggle");
const stayText = document.getElementById("stayText");
const langBtn = document.getElementById("langBtn");
const langText = document.getElementById("langText");
const exportBtn = document.getElementById("exportBtn");
const categoryView = document.getElementById("categoryView");
const subcategoryView = document.getElementById("subcategoryView");
const voiceView = document.getElementById("voiceView");
const recordsView = document.getElementById("recordsView");
const categoryButtons = document.getElementById("categoryButtons");
const subcategoryButtons = document.getElementById("subcategoryButtons");
const subcategoryTitle = document.getElementById("subcategoryTitle");
const voiceTitle = document.getElementById("voiceTitle");
const recordsContainer = document.getElementById("recordsContainer");
const totalDisplay = document.getElementById("totalDisplay");

// Initialize the app
function initApp() {
  // Set up event listeners
  stayToggle.addEventListener("click", toggleStayMode);
  langBtn.addEventListener("click", toggleLanguage);
  exportBtn.addEventListener("click", () => showView('recordsView'));
  
  // Render categories
  renderCategories();
  
  // Load records
  loadRecords();
  
  // Show category view by default
  showView('categoryView');
  
  // Add click listener to close swiped items when clicking elsewhere
  document.addEventListener('click', (e) => {
    if (activeSwipeItem && !e.target.closest('.expense-item')) {
      activeSwipeItem.classList.remove('swiped');
      activeSwipeItem = null;
    }
  });
}

// Toggle stay mode
function toggleStayMode() {
  stayOn = !stayOn;
  stayText.textContent = stayOn ? "Stay ON" : "Stay OFF";
  stayToggle.classList.toggle("active", stayOn);
}

// Toggle language
function toggleLanguage() {
  currentLang = currentLang === "te-IN" ? "en-US" : "te-IN";
  const langName = currentLang === "te-IN" ? "Telugu" : "English";
  langText.textContent = langName;
  
  // Show feedback
  showToast(`Language changed to ${langName}`);
}

// Show a specific view with animation
function showView(viewId) {
  // Hide all views
  document.querySelectorAll('.view').forEach(view => {
    view.classList.remove('active');
  });
  
  // Show the selected view
  const targetView = document.getElementById(viewId);
  targetView.classList.add('active');
  
  // If showing records, reload them
  if (viewId === 'recordsView') {
    loadRecords();
  }
}

// Render categories
function renderCategories() {
  categoryButtons.innerHTML = '';
  
  for (let cat in categories) {
    const btn = document.createElement('button');
    btn.className = 'btn btn-category ripple';
    btn.innerHTML = `<i class="fas fa-${getCategoryIcon(cat)}"></i> ${cat}`;
    btn.onclick = () => showSubcategories(cat);
    categoryButtons.appendChild(btn);
  }
  
  // Add view records button
  const viewRecordsBtn = document.createElement('button');
  viewRecordsBtn.className = 'btn btn-back ripple';
  viewRecordsBtn.innerHTML = `<i class="fas fa-history"></i> View Records`;
  viewRecordsBtn.onclick = () => showView('recordsView');
  categoryButtons.appendChild(viewRecordsBtn);
}

// Get icon for category
function getCategoryIcon(category) {
  const icons = {
    "Needs": "home",
    "Wants": "shopping-bag",
    "Medical/Healthcare": "heartbeat",
    "Education": "graduation-cap",
    "Banking/Finance": "credit-card"
  };
  
  return icons[category] || "folder";
}

// Show subcategories for a category
function showSubcategories(cat) {
  currentCategory = cat;
  subcategoryTitle.innerHTML = `<i class="fas fa-${getCategoryIcon(cat)}"></i> ${cat} - Select Subcategory`;
  subcategoryButtons.innerHTML = '';
  
  categories[cat].forEach(sub => {
    const btn = document.createElement('button');
    btn.className = 'btn btn-subcategory ripple';
    btn.innerHTML = `<i class="fas fa-${getSubcategoryIcon(sub)}"></i> ${sub}`;
    btn.onclick = () => startVoice(sub);
    subcategoryButtons.appendChild(btn);
  });
  
  showView('subcategoryView');
}

// Get icon for subcategory
function getSubcategoryIcon(subcategory) {
  const icons = {
    "House Rent": "home",
    "Electricity Bill": "bolt",
    "Cable Bill": "tv",
    "Phone Bill": "phone",
    "Transportation": "bus",
    "Beverages/Dairy": "coffee",
    "Gas": "gas-pump",
    "Rice": "utensils",
    "Groceries": "shopping-basket",
    "Vegetable": "carrot",
    "Non Vegitable": "drumstick",
    "Fruits": "apple-alt",
    "Bakery/Snacks": "cookie",
    "Cleaners/Personal Care": "soap",
    "Repairs & Maintenance": "tools",
    "Shopping": "shopping-cart",
    "Entertainment": "film",
    "Vacation": "umbrella-beach",
    "Charity/Donations/Gifts": "gift",
    "Clothing/Beauty": "tshirt",
    "EatOut": "utensils",
    "Other": "question-circle",
    "Hospital": "hospital",
    "Medicine": "pills",
    "Lab Reports": "file-medical",
    "Exam Fee": "file-alt",
    "Books": "book",
    "Stationery": "pencil-alt",
    "Admission Fee": "user-graduate",
    "Tutoring Fee": "chalkboard-teacher",
    "Debts": "money-bill-wave",
    "Insurance": "shield-alt",
    "ATM/SMS Charges": "money-check",
    "Fund Transfer Charges": "exchange-alt",
    "Salary Deductions": "file-invoice-dollar",
    "Tax": "calculator",
    "Account Maintenance Charges": "credit-card",
    "Losses On Investment": "chart-line"
  };
  
  return icons[subcategory] || "list";
}

// Start voice recognition
function startVoice(subcat) {
  currentSubcategory = subcat;
  voiceTitle.innerHTML = `<i class="fas fa-microphone"></i> ${currentCategory} - ${subcat}`;
  showView('voiceView');
  
  // Check if browser supports speech recognition
  if (!('webkitSpeechRecognition' in window)) {
    showToast("Speech recognition not supported in this browser");
    return;
  }
  
  // Clear any existing timeout
  if (recognitionTimeout) {
    clearTimeout(recognitionTimeout);
    recognitionTimeout = null;
  }
  
  // Initialize speech recognition
  speechRecognition = new webkitSpeechRecognition();
  speechRecognition.continuous = false;
  speechRecognition.interimResults = false;
  speechRecognition.lang = currentLang;
  
  speechRecognition.onstart = function() {
    console.log("Speech recognition started");
  };
  
  speechRecognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript.trim();
    processVoiceInput(transcript);
    
    // Clear timeout since we got a result
    if (recognitionTimeout) {
      clearTimeout(recognitionTimeout);
      recognitionTimeout = null;
    }
  };
  
  speechRecognition.onerror = function(event) {
    console.error("Speech recognition error", event.error);
    showToast("Error: " + event.error);
    showView('subcategoryView');
    
  };
  
  speechRecognition.onend = function() {
    console.log("Speech recognition ended");
  };
  
  // Start recognition
  try {
    speechRecognition.start();
    
    // Set timeout to stop recognition after 10 seconds
    recognitionTimeout = setTimeout(() => {
      if (speechRecognition) {
        speechRecognition.stop();
        if (voiceView.classList.contains('active')) {
          showToast("Listening time out. Please try again.");
          showView('subcategoryView');
        }
      }
    }, 10000);
  } catch (error) {
    showToast("Error starting speech recognition");
    console.error("Error starting speech recognition:", error);
  }
}

// Process voice input
function processVoiceInput(transcript) {
  // Parse the transcript to extract amount and description
  const parts = transcript.split(" ");
  let amount = 0;
  let description = "";
  
  // Try to find the amount (last number in the transcript)
  for (let i = parts.length - 1; i >= 0; i--) {
    const num = parseFloat(parts[i]);
    if (!isNaN(num)) {
      amount = num;
      parts.splice(i, 1); // Remove the amount from parts
      description = parts.join(" ").trim();
      break;
    }
  }
  
  // If no amount found, try to find it in the middle
  if (amount === 0) {
    for (let i = 0; i < parts.length; i++) {
      const num = parseFloat(parts[i]);
      if (!isNaN(num)) {
        amount = num;
        parts.splice(i, 1); // Remove the amount from parts
        description = parts.join(" ").trim();
        break;
      }
    }
  }
  
  // If still no amount found, show error
  if (amount === 0) {
    showToast("Could not detect amount. Please try again.");
    showView('subcategoryView');
    return;
  }
  
  // If no description, use subcategory as description
  if (!description) {
    description = currentSubcategory;
  }
  
  // Save the record
  saveRecord(currentCategory, currentSubcategory, description, amount);
  
  // Show success message
  showToast(`Added: ${description} - ₹${amount}`);
  
  // Return to appropriate view
  if (stayOn) {
    showView('subcategoryView');
  } else {
    showView('categoryView');
  }
}

// Save record to localStorage
function saveRecord(cat, subcat, desc, amt) {
  let records = JSON.parse(localStorage.getItem("expenses") || "[]");
  
  records.push({
    id: Date.now(),
    date: new Date().toLocaleDateString('en-IN'),
    category: cat,
    subcategory: subcat,
    description: desc,
    amount: amt
  });
  
  localStorage.setItem("expenses", JSON.stringify(records));
  loadRecords();
}

// Toggle date group collapse
function toggleDateGroup(date) {
  collapsedDates[date] = !collapsedDates[date];
  loadRecords();
}

// Load records from localStorage and group by date and category
function loadRecords() {
  const records = JSON.parse(localStorage.getItem("expenses") || "[]");
  recordsContainer.innerHTML = "";
  
  if (records.length === 0) {
    recordsContainer.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-receipt"></i>
        <div>No expenses recorded yet</div>
      </div>
    `;
    totalDisplay.textContent = "Total: ₹0";
    return;
  }
  
  // Sort records by date (newest first)
  records.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  // Group records by date
  const recordsByDate = {};
  let grandTotal = 0;
  
  records.forEach(record => {
    if (!recordsByDate[record.date]) {
      recordsByDate[record.date] = [];
    }
    recordsByDate[record.date].push(record);
    grandTotal += record.amount;
  });
  
  // Create HTML for each date group
  for (const date in recordsByDate) {
    const dateRecords = recordsByDate[date];
    let dateTotal = 0;
    
    // Group records by category within this date
    const recordsByCategory = {};
    dateRecords.forEach(record => {
      if (!recordsByCategory[record.category]) {
        recordsByCategory[record.category] = [];
      }
      recordsByCategory[record.category].push(record);
      dateTotal += record.amount;
    });
    
    // Create date group element
    const dateGroup = document.createElement('div');
    dateGroup.className = 'date-group';
    
    // Date header
    const dateHeader = document.createElement('div');
    dateHeader.className = `date-header ${collapsedDates[date] ? 'collapsed' : ''}`;
    dateHeader.innerHTML = `
      <span><i class="fas fa-chevron-down"></i> ${date}</span>
      <span class="date-total">₹${dateTotal.toFixed(2)}</span>
    `;
    dateHeader.onclick = () => toggleDateGroup(date);
    dateGroup.appendChild(dateHeader);
    
    // Date content
    const dateContent = document.createElement('div');
    dateContent.className = `date-content ${collapsedDates[date] ? 'collapsed' : ''}`;
    
    // Add category groups
    for (const category in recordsByCategory) {
      const categoryRecords = recordsByCategory[category];
      let categoryTotal = 0;
      
      // Create category group element
      const categoryGroup = document.createElement('div');
      categoryGroup.className = 'category-group';
      
      // Category header
      const categoryHeader = document.createElement('div');
      categoryHeader.className = 'category-header';
      categoryHeader.innerHTML = `
        <span class="category-name">${category}</span>
        <span class="category-total">₹${categoryRecords.reduce((sum, record) => sum + record.amount, 0).toFixed(2)}</span>
      `;
      categoryGroup.appendChild(categoryHeader);
      
      // Create table for expenses
      const table = document.createElement('table');
      table.className = 'expense-table';
      
      // Table header
      const thead = document.createElement('thead');
      thead.innerHTML = `
        
      `;
      table.appendChild(thead);
      
      // Table body
      const tbody = document.createElement('tbody');
      
      // Add expense items
      categoryRecords.forEach(record => {
        categoryTotal += record.amount;
        
        // Create expense item container
        const itemContainer = document.createElement('div');
        itemContainer.className = 'expense-item';
        itemContainer.setAttribute('data-id', record.id);
        
        // Create expense content
        const contentDiv = document.createElement('div');
        contentDiv.className = 'expense-content';
        contentDiv.innerHTML = `
          <div class="expense-info">
            <div class="expense-description">${record.description}</div>
            <div class="expense-subcategory">${record.subcategory}</div>
          </div>
          <div class="expense-amount">₹${record.amount.toFixed(2)}</div>
        `;
        
        // Create action buttons
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'expense-actions';
        actionsDiv.innerHTML = `
          <button class="action-btn action-edit" onclick="event.stopPropagation(); editRecordById('${record.id}')">
            <i class="fas fa-edit"></i>
          </button>
          <button class="action-btn action-delete" onclick="event.stopPropagation(); deleteRecordById('${record.id}')">
            <i class="fas fa-trash"></i>
          </button>
        `;
        
        // Add click event to show actions
        contentDiv.addEventListener('click', (e) => {
          e.stopPropagation();
          
          // Close any previously swiped item
          if (activeSwipeItem && activeSwipeItem !== itemContainer) {
            activeSwipeItem.classList.remove('swiped');
          }
          
          // Toggle current item
          itemContainer.classList.toggle('swiped');
          
          // Update active item
          if (itemContainer.classList.contains('swiped')) {
            activeSwipeItem = itemContainer;
          } else {
            activeSwipeItem = null;
          }
        });
        
        // Add touch events for mobile swipe
        let startX, currentX, diffX;
        
        contentDiv.addEventListener('touchstart', (e) => {
          startX = e.touches[0].clientX;
        });
        
        contentDiv.addEventListener('touchmove', (e) => {
          if (!startX) return;
          
          currentX = e.touches[0].clientX;
          diffX = currentX - startX;
          
          // Only allow left swipe
          if (diffX < 0) {
            e.preventDefault();
            itemContainer.style.transform = `translateX(${Math.max(diffX, -80)}px)`;
          }
        });
        
        contentDiv.addEventListener('touchend', () => {
          if (!startX) return;
          
          // If swiped more than 40px, toggle swiped state
          if (diffX < -40) {
            // Close any previously swiped item
            if (activeSwipeItem && activeSwipeItem !== itemContainer) {
              activeSwipeItem.classList.remove('swiped');
            }
            
            itemContainer.classList.add('swiped');
            activeSwipeItem = itemContainer;
          } else {
            itemContainer.classList.remove('swiped');
            if (activeSwipeItem === itemContainer) {
              activeSwipeItem = null;
            }
          }
          
          itemContainer.style.transform = '';
          startX = null;
        });
        
        // Add to container
        itemContainer.appendChild(contentDiv);
        itemContainer.appendChild(actionsDiv);
        
        // Create table row for the item
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 2;
        cell.style.padding = '0';
        cell.appendChild(itemContainer);
        row.appendChild(cell);
        tbody.appendChild(row);
      });
      
      table.appendChild(tbody);
      categoryGroup.appendChild(table);
      dateContent.appendChild(categoryGroup);
    }
    
    dateGroup.appendChild(dateContent);
    recordsContainer.appendChild(dateGroup);
  }
  
  totalDisplay.textContent = `Total: ₹${grandTotal.toFixed(2)}`;
}

// Edit record by ID
function editRecordById(id) {
  let records = JSON.parse(localStorage.getItem("expenses") || "[]");
  const recordIndex = records.findIndex(r => r.id == id);
  
  if (recordIndex === -1) {
    showToast("Record not found");
    return;
  }
  
  const record = records[recordIndex];
  
  // In a real app, you would show an edit form
  // For this demo, we'll just show a prompt
  const newAmount = parseFloat(prompt("Enter new amount:", record.amount));
  
  if (!isNaN(newAmount) && newAmount > 0) {
    records[recordIndex].amount = newAmount;
    localStorage.setItem("expenses", JSON.stringify(records));
    loadRecords();
    showToast("Record updated");
    
    // Close the swipe actions
    if (activeSwipeItem) {
      activeSwipeItem.classList.remove('swiped');
      activeSwipeItem = null;
    }
  } else {
    showToast("Invalid amount");
  }
}

// Delete record by ID
function deleteRecordById(id) {
  let records = JSON.parse(localStorage.getItem("expenses") || "[]");
  const recordIndex = records.findIndex(r => r.id == id);
  
  if (recordIndex === -1) {
    showToast("Record not found");
    return;
  }
  
  if (confirm("Are you sure you want to delete this record?")) {
    records.splice(recordIndex, 1);
    localStorage.setItem("expenses", JSON.stringify(records));
    loadRecords();
    showToast("Record deleted");
    
    // Close the swipe actions
    if (activeSwipeItem) {
      activeSwipeItem.classList.remove('swiped');
      activeSwipeItem = null;
    }
  }
}

// Export to CSV
function exportToCSV() {
  const records = JSON.parse(localStorage.getItem("expenses") || "[]");
  
  if (records.length === 0) {
    showToast("No records to export");
    return;
  }
  
  // Create CSV content
  let csvContent = "Date,Category,Subcategory,Description,Amount\n";
  
  records.forEach(record => {
    csvContent += `"${record.date}","${record.category}","${record.subcategory}","${record.description}",${record.amount}\n`;
  });
  
  // Create download link
  const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "expenses.csv");
  document.body.appendChild(link);
  
  // Trigger download
  link.click();
  document.body.removeChild(link);
  
  showToast("CSV exported successfully");
}

// Show toast message
function showToast(message) {
  // Remove existing toast if any
  const existingToast = document.querySelector('.toast');
  if (existingToast) {
    existingToast.remove();
  }
  
  // Create toast element
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 12px 24px;
    border-radius: 50px;
    z-index: 1000;
    font-weight: 500;
    animation: fadeIn 0.3s ease;
  `;
  
  document.body.appendChild(toast);
  
  // Remove toast after 3 seconds
  setTimeout(() => {
    if (toast.parentNode) {
      toast.style.animation = 'fadeOut 0.3s ease forwards';
      setTimeout(() => toast.remove(), 300);
    }
  }, 3000);
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
